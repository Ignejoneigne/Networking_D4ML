#!/bin/bash

# Flush existing rules and set default policies to DROP
sudo iptables -F
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT


# Allow loopback traffic
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A OUTPUT -o lo -j ACCEPT

# Allow established and related connections
sudo iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# 1. Allow incoming connections to port 25 (SMTP) from the internet
sudo iptables -A INPUT -p tcp --dport 25 -j ACCEPT

# 2. Allow outbound DNS connections (port 53 TCP/UDP)
sudo iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
sudo iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT

# 3. Close incoming connections to port 143 (IMAP)
sudo iptables -A INPUT -p tcp --dport 143 -j DROP

# 4. Allow incoming connections to port 993 (IMAPS) for HR department (192.168.42.150-199) and Backup server (192.168.42.250)
sudo iptables -A INPUT -s 192.168.42.150/29 -p tcp --dport 993 -j ACCEPT
sudo iptables -A INPUT -s 192.168.42.250 -p tcp --dport 993 -j ACCEPT


# 5. Allow incoming connections to port 465 (SMTPS) for IT department (192.168.42.200-220)
sudo iptables -A INPUT -s 192.168.42.200/28 -p tcp --dport 465 -j ACCEPT

# 6. Allow incoming connections to port 587 (SMTP) for HR department (192.168.42.150-199) and IT department (192.168.42.200-220)
sudo iptables -A INPUT -s 192.168.42.150/29 -p tcp --dport 587 -j ACCEPT
sudo iptables -A INPUT -s 192.168.42.200/29 -p tcp --dport 587 -j ACCEPT

# 7. Allow incoming SMB connections (assuming SMB uses ports 137-139)
sudo iptables -A INPUT -s 192.168.42.250 -p tcp -m multiport --sports 137:139 -j ACCEPT
sudo iptables -A INPUT -s 192.168.42.250 -p udp -m multiport --sports 137:139 -j ACCEPT

# 8. Allow SSH access (default port 22) for IT department (192.168.42.200-220)
sudo iptables -A INPUT -s 192.168.42.200/28 -p tcp --dport 22 -j ACCEPT


# 9. Restrict all other incoming connections (except port 443)
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
sudo iptables -A INPUT -j DROP
